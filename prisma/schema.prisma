// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  username      String    @unique @db.VarChar(50)
  email         String    @unique @db.VarChar(255)
  emailVerified Boolean   @default(false)
  passwordHash  String?   @db.VarChar(255)

  // Profile
  displayName   String?   @db.VarChar(100)
  bio           String?   @db.Text
  avatarUrl     String?   @db.Text
  location      String?   @db.VarChar(100)
  theme         String    @default("space") @db.VarChar(50)
  donationUrl   String?   @db.VarChar(500)
  profileFont   String?   @db.VarChar(100)  // Pro feature: custom body font
  headingFont   String?   @db.VarChar(100)  // Pro feature: custom heading font

  // Pro feature: Analytics pixels
  facebookPixelId    String?   @db.VarChar(50)
  googleAnalyticsId  String?   @db.VarChar(50)
  tiktokPixelId      String?   @db.VarChar(50)

  // Gamification & Stats
  totalProfileViews Int     @default(0)
  totalLinkClicks   Int     @default(0)
  isFeatured        Boolean @default(false)

  // Metadata
  role          String    @default("user") @db.VarChar(20)
  subscriptionTier   String  @default("free") @db.VarChar(50)
  subscriptionStatus String  @default("active") @db.VarChar(50)
  stripeCustomerId   String? @unique @db.VarChar(255)

  // Timestamps
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  lastLoginAt        DateTime?
  lastUsernameChange DateTime?

  // Relations
  oauthAccounts       OAuthAccount[]
  verificationTokens  VerificationToken[]
  loginVerifications  LoginVerification[]
  platformConnections PlatformConnection[]
  links               Link[]
  profileViews      ProfileView[]
  linkClicks        LinkClick[]
  linkClicksDaily   LinkClickDaily[]
  referrerStats     ReferrerStat[]
  geoStats          GeoStat[]
  subscriptions     Subscription[]
  payments          Payment[]
  moderationFlags   ModerationFlag[] @relation("FlaggedUser")
  flaggedBy         ModerationFlag[] @relation("Flagger")
  resolvedFlags     ModerationFlag[] @relation("Resolver")
  adminLogs         AdminLog[]
  achievements      UserAchievement[]
  customThemes      CustomTheme[]
  contactMessagesReceived ContactMessage[]
  supportTickets    SupportTicket[]
  resolvedTickets   SupportTicket[] @relation("TicketResolver")

  @@map("users")
}

model OAuthAccount {
  id                String   @id @default(cuid())
  userId            String
  provider          String   @db.VarChar(50)
  providerAccountId String   @db.VarChar(255)
  accessToken       String?  @db.Text
  refreshToken      String?  @db.Text
  expiresAt         BigInt?
  tokenType         String?  @db.VarChar(50)
  scope             String?  @db.Text
  idToken           String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("oauth_accounts")
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique @db.VarChar(255)
  type      String   @db.VarChar(50)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("verification_tokens")
}

model LoginVerification {
  id          String   @id @default(cuid())
  userId      String
  token       String   @unique @db.VarChar(255)
  code        String   @db.VarChar(6)  // 6-digit code for easy entry
  ipAddress   String?  @db.VarChar(45)
  userAgent   String?  @db.Text
  deviceType  String?  @db.VarChar(50)
  browser     String?  @db.VarChar(100)
  location    String?  @db.VarChar(255)
  isVerified  Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  verifiedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_verifications")
}

// ============================================
// VERIFIED PLATFORM CONNECTIONS
// ============================================

model PlatformConnection {
  id                String   @id @default(cuid())
  userId            String
  platform          String   @db.VarChar(50)  // github, instagram, twitter, youtube, tiktok, etc.
  platformUserId    String   @db.VarChar(255) // Their ID on that platform
  platformUsername  String   @db.VarChar(255) // Their username on that platform
  profileUrl        String   @db.VarChar(500) // Full profile URL
  displayName       String?  @db.VarChar(255) // Display name from platform
  avatarUrl         String?  @db.VarChar(500) // Avatar from platform
  accessToken       String?  @db.Text         // For API access if needed
  refreshToken      String?  @db.Text
  expiresAt         DateTime?
  isVerified        Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  links Link[]

  @@unique([userId, platform])
  @@unique([platform, platformUserId])
  @@map("platform_connections")
}

// ============================================
// LINKS (Now require verified platform connection)
// ============================================

model Link {
  id                     String   @id @default(cuid())
  userId                 String
  platformConnectionId   String?  // Links to verified platform
  title                  String   @db.VarChar(255)
  url                    String   @db.VarChar(2000)
  platform               String?  @db.VarChar(50)
  icon                   String?  @db.VarChar(100)
  displayOrder           Int      @default(0)
  isActive               Boolean  @default(true)
  isVerified             Boolean  @default(false) // True if linked to platform connection
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // A/B Testing (Pro feature)
  abTestEnabled      Boolean  @default(false)

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  platformConnection PlatformConnection? @relation(fields: [platformConnectionId], references: [id], onDelete: SetNull)
  linkClicks         LinkClick[]
  linkClicksDaily    LinkClickDaily[]
  moderationFlags    ModerationFlag[]
  variants           LinkVariant[]

  @@map("links")
}

// ============================================
// A/B TESTING (Pro feature)
// ============================================

model LinkVariant {
  id           String   @id @default(cuid())
  linkId       String
  name         String   @db.VarChar(50)   // "A", "B", "C", etc.
  title        String   @db.VarChar(255)
  url          String   @db.VarChar(2000)
  weight       Int      @default(50)       // Traffic percentage (0-100)
  impressions  Int      @default(0)
  clicks       Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  link        Link        @relation(fields: [linkId], references: [id], onDelete: Cascade)
  linkClicks  LinkClick[]

  @@map("link_variants")
}

// ============================================
// ANALYTICS
// ============================================

model ProfileView {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime @db.Date
  totalViews  Int      @default(0)
  uniqueViews Int      @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("profile_views")
}

model LinkClick {
  id         String   @id @default(cuid())
  linkId     String
  userId     String
  variantId  String?  // A/B test variant that was clicked
  visitorId  String?  @db.VarChar(255)
  ipAddress  String?  @db.VarChar(45)
  country    String?  @db.VarChar(2)
  city       String?  @db.VarChar(100)
  region     String?  @db.VarChar(100)
  userAgent  String?  @db.Text
  referrer   String?  @db.VarChar(500)
  deviceType String?  @db.VarChar(50)
  browser    String?  @db.VarChar(100)
  os         String?  @db.VarChar(100)
  clickedAt  DateTime @default(now())

  link    Link         @relation(fields: [linkId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  variant LinkVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([linkId])
  @@index([userId])
  @@index([clickedAt])
  @@index([variantId])
  @@map("link_clicks")
}

model LinkClickDaily {
  id           String   @id @default(cuid())
  linkId       String
  userId       String
  date         DateTime @db.Date
  totalClicks  Int      @default(0)
  uniqueClicks Int      @default(0)

  link Link @relation(fields: [linkId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([linkId, date])
  @@map("link_clicks_daily")
}

model ReferrerStat {
  id             String   @id @default(cuid())
  userId         String
  date           DateTime @db.Date
  referrerDomain String   @db.VarChar(255)
  visits         Int      @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, referrerDomain])
  @@map("referrer_stats")
}

model GeoStat {
  id      String   @id @default(cuid())
  userId  String
  date    DateTime @db.Date
  country String   @db.VarChar(2)
  city    String?  @db.VarChar(100)
  visits  Int      @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, country, city])
  @@map("geo_stats")
}

// ============================================
// SUBSCRIPTIONS
// ============================================

model Subscription {
  id                    String    @id @default(cuid())
  userId                String
  stripeSubscriptionId  String?   @unique @db.VarChar(255)
  stripePriceId         String?   @db.VarChar(255)
  tier                  String    @db.VarChar(50)
  status                String    @db.VarChar(50)
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAt              DateTime?
  canceledAt            DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@map("subscriptions")
}

model Payment {
  id                     String    @id @default(cuid())
  userId                 String
  subscriptionId         String?
  stripePaymentIntentId  String?   @unique @db.VarChar(255)
  amount                 Int
  currency               String    @default("usd") @db.VarChar(3)
  status                 String    @db.VarChar(50)
  createdAt              DateTime  @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@map("payments")
}

// ============================================
// FEATURE FLAGS & ADMIN
// ============================================

model FeatureFlag {
  id               String   @id @default(cuid())
  name             String   @unique @db.VarChar(100)
  description      String?  @db.Text
  enabledForFree   Boolean  @default(false)
  enabledForPro    Boolean  @default(false)
  enabledForPremium Boolean @default(true)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("feature_flags")
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique @db.VarChar(100)
  value       String?  @db.Text
  type        String   @default("string") @db.VarChar(50)
  description String?  @db.Text
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model ModerationFlag {
  id          String    @id @default(cuid())
  userId      String
  linkId      String?
  reason      String    @db.VarChar(255)
  description String?   @db.Text
  flaggedById String?
  status      String    @default("pending") @db.VarChar(50)
  resolution  String?   @db.Text
  resolvedById String?
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())

  user       User  @relation("FlaggedUser", fields: [userId], references: [id], onDelete: Cascade)
  link       Link? @relation(fields: [linkId], references: [id], onDelete: Cascade)
  flaggedBy  User? @relation("Flagger", fields: [flaggedById], references: [id], onDelete: SetNull)
  resolvedBy User? @relation("Resolver", fields: [resolvedById], references: [id], onDelete: SetNull)

  @@map("moderation_flags")
}

model AdminLog {
  id         String   @id @default(cuid())
  adminId    String
  action     String   @db.VarChar(100)
  targetType String?  @db.VarChar(50)
  targetId   String?  @db.VarChar(255)
  details    Json?
  ipAddress  String?  @db.VarChar(45)
  createdAt  DateTime @default(now())

  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_logs")
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String   @unique @db.VarChar(100)
  subject   String   @db.VarChar(255)
  body      String   @db.Text
  variables Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

// ============================================
// GAMIFICATION - ACHIEVEMENTS
// ============================================

model Achievement {
  id          String   @id @default(cuid())
  name        String   @unique @db.VarChar(100)
  description String   @db.Text
  icon        String   @db.VarChar(50)  // emoji or icon name
  category    String   @db.VarChar(50)  // pioneer, engagement, social, etc.
  requirement Int      @default(0)       // numeric threshold for achievement
  createdAt   DateTime @default(now())

  users UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id               String   @id @default(cuid())
  userId           String
  achievementId    String
  unlockedAt       DateTime @default(now())
  displayOnProfile Boolean  @default(true)

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// ============================================
// GAMIFICATION - CUSTOM THEMES
// ============================================

model CustomTheme {
  id              String   @id @default(cuid())
  userId          String
  name            String   @db.VarChar(100)
  backgroundColor String   @db.VarChar(50)
  textColor       String   @db.VarChar(50)
  buttonColor     String   @db.VarChar(50)
  buttonTextColor String   @db.VarChar(50)
  accentColor     String?  @db.VarChar(50)
  fontFamily      String?  @db.VarChar(100)
  isActive        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("custom_themes")
}

// ============================================
// SUPPORT TICKETS
// ============================================

model SupportTicket {
  id          String   @id @default(cuid())
  userId      String?
  email       String   @db.VarChar(255)
  name        String?  @db.VarChar(100)
  subject     String   @db.VarChar(200)
  message     String   @db.Text
  category    String   @default("general") @db.VarChar(50)  // general, bug, feature, billing, account
  priority    String   @default("medium") @db.VarChar(20)   // low, medium, high, urgent
  status      String   @default("open") @db.VarChar(20)     // open, in_progress, resolved, closed
  adminNotes  String?  @db.Text
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  resolver    User?    @relation("TicketResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("support_tickets")
}

// ============================================
// CONTACT FORM MESSAGES
// ============================================

model ContactMessage {
  id          String   @id @default(cuid())
  recipientId String
  senderName  String   @db.VarChar(100)
  senderEmail String   @db.VarChar(255)
  subject     String?  @db.VarChar(200)
  message     String   @db.Text
  isRead      Boolean  @default(false)
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())

  recipient User @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId])
  @@index([createdAt])
  @@map("contact_messages")
}
